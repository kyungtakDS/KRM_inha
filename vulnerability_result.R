#'---
#'title: "Vulnerability - 노후건축물비율, 의존인구비율"
#'author: "Kyungtak Kim"
#'date: '2020 3 26 '
#'output: github_document
#'      
#'  
#'---

# 패키지 설치
#install.packages("sf")
#install.packages("tmap")
#install.packages("dplyr")

#+ library, warning=FALSE, message=FALSE
library(tidyverse)
library(sf)
library(tmap)
Sys.setenv(Language="En")
library(caret)
library(knitr)
library(leaflet)
library(rgdal)
library(htmltools)
#install.packages("ggpubr")
library(ggpubr)


#' # 원본 데이터 읽기  
#' 
DB <- read.csv('input/vulnerability_db.csv')
head(DB,3)


#' ## 노후건축물 비율(%)에 대한 분석  
#'   
DB_o <- DB %>% 
  select(NameK, SGG, contains("phy"))
head(DB_o, 3)
DB_o_p <- DB_o %>%                           # pivoting
  pivot_longer(c("X16_vul_phy", "X17_vul_phy"),
               names_to = "year",
               values_to = "old_build")
DB_o_p %>% 
  ggplot()+
  geom_density(aes(x=old_build, y=..density.., color=year))

#' SGG는 시군 고유번호로 지역별 대략적인 분포를 알 수 있다.  
#' 서울시의 노후건출무 비율이 75% 정도임.  
#'
DB_o_p %>% 
  group_by(year) %>% 
  ggplot(aes(old_build, SGG))+
  geom_point(aes(color=factor(SGG)))+
  facet_grid(. ~year)+
  theme(legend.position = "none")

#' 충북증평군이 16-17년 노후건축물의 차이가 가장 큰 이유는?  
#'
#+ fig.width=12, fig.height=25
DB_o_p %>% 
  group_by(NameK) %>% 
  mutate(mean=mean(old_build))%>% 
  ggplot(aes(x=fct_reorder(NameK, mean),
             y=old_build))+
  geom_boxplot()+
  coord_flip()

#' 정규성(Normality test)  
#' ** shapiro-wilk normality test**  
#' ** p-value가 모두 0.05 보다 작게나오므로 정규성 가정에 위배된다.**
#' 
ggqqplot(DB$X16_vul_phy)
shapiro.test(DB$X16_vul_phy)
ggqqplot(DB$X17_vul_phy)
shapiro.test(DB$X17_vul_phy)


#' ## 의존인구비율(%)에 대한 분석  
#'   
DB_d <- DB %>% 
  select(NameK, SGG, contains("soc"))
head(DB_d, 3)
DB_d_p <- DB_d %>%                           # pivoting
  pivot_longer(c("X16_vul_soc", "X17_vul_soc"),
               names_to = "year",
               values_to = "depend_peo")
DB_d_p %>% 
  ggplot()+
  geom_density(aes(x=depend_peo, y=..density.., color=year))

#' SGG는 시군 고유번호로 지역별 대략적인 분포를 알 수 있다.  
#' 광역도시는 의존인구비율이 낮고 지방으로 가면 늘어난다.  
#'
DB_d_p %>% 
  group_by(year) %>% 
  ggplot(aes(depend_peo, SGG))+
  geom_point(aes(color=factor(SGG)))+
  facet_grid(. ~year)+
  theme(legend.position = "none")

#' 연천군의 16년과 17년의 의존인구비율의 차이가 많이 난다.???  
#' 
#+ fig.width=12, fig.height=25
DB_d_p %>% 
  group_by(NameK) %>% 
  mutate(mean=mean(depend_peo))%>% 
  ggplot(aes(x=fct_reorder(NameK, mean),
             y=depend_peo))+
  geom_boxplot()+
  coord_flip()

#' 정규성(Normality test)  
#' ** shapiro-wilk normality test**  
#' ** p-value가 모두 0.05 보다 작게나오므로 정규성 가정에 위배된다.**
#' 
ggqqplot(DB$X16_vul_soc)
shapiro.test(DB$X16_vul_soc)
ggqqplot(DB$X17_vul_soc)
shapiro.test(DB$X17_vul_soc)


#' # Vulnerability 지표별 정규화 - root 정규화  
#'    
standard_root <- function(x){
  return((sqrt(x)-min(sqrt(x)))/(max(sqrt(x))-min(sqrt(x))))
}

# 연도별 데이터 프레임에 root 표준화 적용
vulnerability <- as.data.frame(lapply(DB[,4:7],
                                      standard_root))
vulnerability <- cbind(DB[,1:3],
                       vulnerability)
colnames(vulnerability)[4:7] <- c("X16_vul_phy_root",
                                  "X16_vul_soc_root",
                                  "X17_vul_phy_root",
                                  "X17_vul_soc_root")

# 16년~17년 Vulnerability 지수 산정
vul_index_16 <- as.data.frame((rowSums(vulnerability[,4:5]))/2)
colnames(vul_index_16) <- c("X16_vul_index")
vul_index_17 <- as.data.frame((rowSums(vulnerability[,6:7]))/2)
colnames(vul_index_17) <- c("X17_vul_index")
vulnerability <- cbind(vulnerability,
                       c(vul_index_16,vul_index_17))








#' # 최종 min-max 미포함 ----------------------------------------------------------  

# 연도별 Vulnerability 지수 산정
result <- vulnerability[,8:9]
colnames(result) <- c("X16_vulnerability", "X17_vulnerability")
result <- cbind(DB[,1:3], result)
head(result,3)


#' ##  Vulnerability 지수의 특성 분석    
#' 연도별 확률밀도함수  
#'    
result_p <- result %>% 
  select(-Name)
result_p_p <- result_p %>%                           # pivoting
  pivot_longer(c("X16_vulnerability", "X17_vulnerability"),
               names_to = "year",
               values_to = "vulnerability")
result_p_p %>% 
  ggplot()+
  geom_density(aes(x=vulnerability, y=..density.., color=year))
result_p %>% 
  ggplot(aes(X17_vulnerability))+
  geom_histogram(bins=100)

#' 
#+ fig.width=12, fig.height=25
result_p_p %>% 
  group_by(NameK) %>% 
  mutate(mean=mean(vulnerability))%>% 
  ggplot(aes(x=fct_reorder(NameK, mean),
             y=vulnerability))+
  geom_boxplot()+
  coord_flip()

#' 
#+  fig.width=6, fig.height=6
result_p_p %>% 
  group_by(NameK) %>% 
  mutate(mean=mean(vulnerability))%>%   
  filter(mean < 0.25) %>% 
  ggplot(aes(x=fct_reorder(NameK, mean),
             y=vulnerability))+
  geom_boxplot()+
  coord_flip()

#' 
result_p_p %>% 
  group_by(NameK) %>% 
  mutate(mean=mean(vulnerability))%>%   
  filter(mean > 0.75) %>% 
  ggplot(aes(x=fct_reorder(NameK, mean),
             y=vulnerability))+
  geom_boxplot()+
  coord_flip()

#' 
result_p %>% 
  mutate(dif=(X17_vulnerability - X16_vulnerability)) %>% 
  filter(NameK == "서울특별시")
result_p_dif <- result_p%>%
  mutate(dif=(X17_vulnerability - X16_vulnerability)) %>% 
  arrange(-dif)
knitr::kable(result_p_dif[1:10, ])  # 침수구역내 총인구가 늘어난 시군
knitr::kable(result_p_dif[152:161, ])  # 침수구역내 총인구가 줄어든 시군

result_p_p %>% 
  group_by(year) %>% 
  ggplot(aes(vulnerability, SGG))+
  geom_point(aes(color=factor(SGG)))+
  facet_grid(. ~year)+
  theme(legend.position = "none")

#' # Mapping
#' 
# 시군 shp 파일 불러오기
analysis <- st_read("input/analysis.shp")

# 폴리곤 에러 체크(기본 파일을 에러 수정한 파일로 변경하였음)
#st_is_valid(analysis)
#library(lwgeom)
#analysis <- st_make_valid(analysis)
st_is_valid(analysis)

# shp파일에 연도별 Vulnerability 지수(표준화 적용) 추가
analysis <- right_join(analysis, result[,3:5])

# 폴리곤 단순화
analysis_simp <- st_simplify(analysis, dTolerance = 50)

#+ fig.width=12, fig.height=6
# 결과 확인
tmap_mode("plot")
breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1)
facets=c("X16_vulnerability", "X17_vulnerability")
tm_shape(analysis_simp)+
  tm_polygons(facets,
              breaks=breaks,
              palette = c("green", "greenyellow", "yellow", "orange", "red"),
              legend.reverse = TRUE)+
  tm_facets(ncol = 2)+
  tm_layout(legend.position = c("right", "bottom"))+
  tm_compass(type = "rose",
             position = c("right", "top"),
             size = 2.5)+
  tm_scale_bar(breaks = c(0, 25, 50, 100, 150, 200),
               position = c("left", "bottom"))

###################
#' leaflet test
#' 
#+ fig.width=8, fig.height=6
a <- st_transform(analysis_simp, 4326)
pal <- colorBin(
  palette=c("green", "greenyellow", "yellow", "orange", "red"),
  domain=NULL,
  bins = c(0, .2, .4, .6, 0.8, 1),
  pretty = FALSE)

leaflet(a) %>% 
  setView(lng = 128, lat = 35.9, zoom = 7) %>% 
  # base groups
  addPolygons(color = ~pal(X16_vulnerability),
              weight = 1,
              smoothFactor = 0.5,
              opacity = 1.0,
              fillOpacity = 0.5,
              label = ~htmlEscape(NameK),
              popup = ~htmlEscape(X16_vulnerability),
              highlightOptions = highlightOptions(color = "white",
                                                  weight = 2,
                                                  bringToFront = TRUE),
              group="Vulnerability 2016") %>% 
  addPolygons(color = ~pal(X17_vulnerability),
              weight = 1,
              smoothFactor = 0.5,
              opacity = 1.0,
              fillOpacity = 0.5,
              label = ~htmlEscape(NameK),
              popup = ~htmlEscape(X17_vulnerability),
              highlightOptions = highlightOptions(color = "white",
                                                  weight = 2,
                                                  bringToFront = TRUE),
              group="Vulnerability 2017") %>%
  # overlay groups
  addProviderTiles(providers$Esri.WorldStreetMap,
                   group="Esri") %>%  #CartoDB.Positron
  addProviderTiles(providers$CartoDB.Positron,
                   group="CartoDB") %>%  
  addLegend("bottomright",
            pal = pal,
            values = ~X16_vulnerability,
            title = "Hazard Index",
            labFormat = labelFormat(digits=10),
            opacity = 1) %>% 
  hideGroup("CartoDB") %>% 
  #Layer controls
  addLayersControl(baseGroups = c("Vulnerability 2016", "Vulnerability 2017"),
                   overlayGroups = c("Esri", "CartoDB"),
                   options=layersControlOptions(collapsed=FALSE))

#' # 결과값 저장  
#' 
write.csv(result, 'output/vulnerability_result1.csv', row.names = F)










#' # 최종 min-max 포함 -----------------------------------------------------------  

#' # 년도별 Vulnerability 지수를 다시 min-max scaling 적용   
#' 
# Vulnerability 지수 표준화 함수 설정
standard <- function(x){
  return((x-min(x))/(max(x)-min(x)))
}

# 연도별 Vulnerability 지수 표준화 산정
result <- as.data.frame(lapply(vulnerability[,8:9],standard))
colnames(result) <- c("X16_vulnerability", "X17_vulnerability")
result <- cbind(DB[,1:3], result)
head(result,3)


#' ## 표준화된 Vulnerability 지수의 특성 분석    
#' 연도별 확률밀도함수  
#'    
result_p <- result %>% 
  select(-Name)
result_p_p <- result_p %>%                           # pivoting
  pivot_longer(c("X16_vulnerability", "X17_vulnerability"),
               names_to = "year",
               values_to = "vulnerability")
result_p_p %>% 
  ggplot()+
  geom_density(aes(x=vulnerability, y=..density.., color=year))
result_p %>% 
  ggplot(aes(X17_vulnerability))+
  geom_histogram(bins=100)

#' 
#+ fig.width=12, fig.height=25
result_p_p %>% 
  group_by(NameK) %>% 
  mutate(mean=mean(vulnerability))%>% 
  ggplot(aes(x=fct_reorder(NameK, mean),
             y=vulnerability))+
  geom_boxplot()+
  coord_flip()

#' 
#+  fig.width=6, fig.height=6
result_p_p %>% 
  group_by(NameK) %>% 
  mutate(mean=mean(vulnerability))%>%   
  filter(mean < 0.25) %>% 
  ggplot(aes(x=fct_reorder(NameK, mean),
             y=vulnerability))+
  geom_boxplot()+
  coord_flip()

#' 
result_p_p %>% 
  group_by(NameK) %>% 
  mutate(mean=mean(vulnerability))%>%   
  filter(mean > 0.75) %>% 
  ggplot(aes(x=fct_reorder(NameK, mean),
             y=vulnerability))+
  geom_boxplot()+
  coord_flip()

#' 
result_p %>% 
  mutate(dif=(X17_vulnerability - X16_vulnerability)) %>% 
  filter(NameK == "서울특별시")
result_p_dif <- result_p%>%
  mutate(dif=(X17_vulnerability - X16_vulnerability)) %>% 
  arrange(-dif)
knitr::kable(result_p_dif[1:10, ])  # 침수구역내 총인구가 늘어난 시군
knitr::kable(result_p_dif[152:161, ])  # 침수구역내 총인구가 줄어든 시군

result_p_p %>% 
  group_by(year) %>% 
  ggplot(aes(vulnerability, SGG))+
  geom_point(aes(color=factor(SGG)))+
  facet_grid(. ~year)+
  theme(legend.position = "none")

#' # Mapping
#' 
# 시군 shp 파일 불러오기
analysis <- st_read("input/analysis.shp")

# 폴리곤 에러 체크(기본 파일을 에러 수정한 파일로 변경하였음)
#st_is_valid(analysis)
#library(lwgeom)
#analysis <- st_make_valid(analysis)
st_is_valid(analysis)

# shp파일에 연도별 Vulnerability 지수(표준화 적용) 추가
analysis <- right_join(analysis, result[,3:5])

# 폴리곤 단순화
analysis_simp <- st_simplify(analysis, dTolerance = 50)

#+ fig.width=12, fig.height=6
# 결과 확인
tmap_mode("plot")
breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1)
facets=c("X16_vulnerability", "X17_vulnerability")
tm_shape(analysis_simp)+
  tm_polygons(facets,
              breaks=breaks,
              palette = c("green", "greenyellow", "yellow", "orange", "red"),
              legend.reverse = TRUE)+
  tm_facets(ncol = 2)+
  tm_layout(legend.position = c("right", "bottom"))+
  tm_compass(type = "rose",
             position = c("right", "top"),
             size = 2.5)+
  tm_scale_bar(breaks = c(0, 25, 50, 100, 150, 200),
               position = c("left", "bottom"))

###################
#' leaflet test
#' 
#+ fig.width=8, fig.height=6
a <- st_transform(analysis_simp, 4326)
pal <- colorBin(
  palette=c("green", "greenyellow", "yellow", "orange", "red"),
  domain=NULL,
  bins = c(0, .2, .4, .6, 0.8, 1),
  pretty = FALSE)

leaflet(a) %>% 
  setView(lng = 128, lat = 35.9, zoom = 7) %>% 
  # base groups
  addPolygons(color = ~pal(X16_vulnerability),
              weight = 1,
              smoothFactor = 0.5,
              opacity = 1.0,
              fillOpacity = 0.5,
              label = ~htmlEscape(NameK),
              popup = ~htmlEscape(X16_vulnerability),
              highlightOptions = highlightOptions(color = "white",
                                                  weight = 2,
                                                  bringToFront = TRUE),
              group="Vulnerability 2016") %>% 
  addPolygons(color = ~pal(X17_vulnerability),
              weight = 1,
              smoothFactor = 0.5,
              opacity = 1.0,
              fillOpacity = 0.5,
              label = ~htmlEscape(NameK),
              popup = ~htmlEscape(X17_vulnerability),
              highlightOptions = highlightOptions(color = "white",
                                                  weight = 2,
                                                  bringToFront = TRUE),
              group="Vulnerability 2017") %>%
  # overlay groups
  addProviderTiles(providers$Esri.WorldStreetMap,
                   group="Esri") %>%  #CartoDB.Positron
  addProviderTiles(providers$CartoDB.Positron,
                   group="CartoDB") %>%  
  addLegend("bottomright",
            pal = pal,
            values = ~X16_vulnerability,
            title = "Hazard Index",
            labFormat = labelFormat(digits=10),
            opacity = 1) %>% 
  hideGroup("CartoDB") %>% 
  #Layer controls
  addLayersControl(baseGroups = c("Vulnerability 2016", "Vulnerability 2017"),
                   overlayGroups = c("Esri", "CartoDB"),
                   options=layersControlOptions(collapsed=FALSE))

##############
#' # 결과값 저장  
#' 
write.csv(result, 'output/vulnerability_result.csv', row.names = F)

# 열 명칭별 의미

# Name : 161개 시군별 영문명
# NameK : 161개 시군별 한글명
# SGG : 시군구 코드
# X16_vul_phy : 16년도 노후건축물비율(%)
# X17_vul_phy : 17년도 노후건축물비율(%)
# X16_vul_soc : 16년도 의존인구비율(%)
# X17_vul_soc : 17년도 의존인구비율(%)
# X16_vul_phy_root : 16년도 노후건축물비율(root 표준화 적용)
# X17_vul_phy_root : 17년도 노후건축물비율(root 표준화 적용)
# X16_vul_soc_root : 16년도 의존인구비율(root 표준화 적용)
# X17_vul_soc_root : 17년도 의존인구비율(root 표준화 적용)
# X16_vul_index : 16년도 Vulnerability 지수
# X17_vul_index : 17년도 Vulnerability 지수
# X16_vulnerability : 16년도 Vulnerability 지수(표준화 적용)
# X17_vulnerability : 17년도 Vulnerability 지수(표준화 적용)